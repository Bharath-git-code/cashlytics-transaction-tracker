name: Debug Build Environment

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Test project structure
      run: |
        echo "ğŸ“ Project structure:"
        ls -la
        echo ""
        
        echo "ğŸ“„ Checking buildozer.spec:"
        if [ -f buildozer.spec ]; then
          echo "âœ… buildozer.spec found"
          echo "ğŸ“‹ Key settings:"
          grep -E "^(title|package\.name|requirements|android\.api|android\.build_tools)" buildozer.spec
        else
          echo "âŒ buildozer.spec not found"
        fi
        echo ""
        
        echo "ğŸ Checking Python files:"
        find . -name "*.py" | head -10
        echo ""
        
        echo "ğŸ“¦ Checking requirements:"
        if [ -f requirements.txt ]; then
          echo "âœ… requirements.txt found:"
          cat requirements.txt
        else
          echo "âŒ requirements.txt not found"
        fi

    - name: Test Docker availability
      run: |
        echo "ğŸ³ Testing Docker:"
        docker --version
        docker run --rm hello-world

    - name: Test Kivy Buildozer Docker image
      run: |
        echo "ğŸ§ª Testing Kivy Buildozer Docker image:"
        docker run --rm kivy/buildozer:latest bash -c "
          echo 'Docker environment:'
          whoami
          pwd
          python3 --version
          buildozer --version
          echo 'Available tools:'
          which java || echo 'Java not found'
          which python3 || echo 'Python3 not found'
          which buildozer || echo 'Buildozer not found'
        "

    - name: Test minimal buildozer command
      run: |
        echo "ğŸ”§ Testing buildozer init in Docker:"
        docker run --rm \
          -v "${{ github.workspace }}:/home/user/hostcwd" \
          -w /home/user/hostcwd \
          kivy/buildozer:latest \
          bash -c "
            echo 'Working directory contents:'
            ls -la
            echo ''
            echo 'Testing buildozer init:'
            buildozer init || echo 'Init failed or already done'
            echo ''
            echo 'Testing buildozer android list:'
            buildozer android list || echo 'List command failed'
          "